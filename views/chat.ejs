<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebChat</title>
  <link rel="stylesheet" href="../public/assets/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <form id='nickname-form'>
    <label for='nickname'>Insira seu nickname</label>
    <input type="text" id="nickname-box" name="nickname" data-testid="nickname-box">
    <button type="submit" id="nickname-button" data-testid="nickname-button">Salvar</button>
  </form>
  <h3>Usu√°rios</h3>
  <ul id="online-users">
    <li id="online-user"></li>
  </ul>
  <h3>Mensagens</h3>
  <ul id="messages">
    <%dataDb.forEach((message)=>{%><li data-testid="message"><%= `${message.timestamp} - ${message.nickname}: ${message.chatMessage}` %></li><%})%>
  </ul>
  <form id='newMessageForm'>
    <input type="text" placeholder="Digite uma nova mensagem aqui" id="newMessage" data-testid="message-box">
    <button type="submit" id="submitNewMessage" data-testid="send-button">Enviar</button>
  </form>

  <script>
    const socket = io();
    const { sessionStorage } = window;

    socket.on('setIdNickname', () => {
      const sessionNickname = sessionStorage.getItem('nickname');
      if(!sessionNickname){
        sessionStorage.setItem('nickname', socket.id.slice(4));
      }
      const nickname = sessionStorage.getItem('nickname');
      socket.emit('updateIdNicknameArray', {[socket.id]: nickname})
      // const nicknameElement = document.getElementById('nicknameElement');
      // nicknameElement.innerText = nickname;
    })

    socket.on('message', (data) => {
      const li = document.createElement('li');
      li.innerText = data;
      li.setAttribute('data-testid', 'message')
      document.getElementById('messages').appendChild(li);
    });

    const btn = document.getElementById('submitNewMessage');
      btn.addEventListener('click', () => {
        const text = document.getElementById('newMessage');
        const nickname = sessionStorage.getItem('nickname');
        socket.emit('message', { chatMessage: text.value, nickname });
        text.value = '';
      });

    const newMessageForm = document.getElementById('newMessageForm');
      newMessageForm.addEventListener('submit', (e)=> e.preventDefault());
    const nicknameForm = document.getElementById('nickname-form');
      nicknameForm.addEventListener('submit', (e)=> e.preventDefault());

    const nicknameButton = document.getElementById('nickname-button');
      nicknameButton.addEventListener('click', () => {
        const nicknameInputEl = document.getElementById('nickname-box');
        sessionStorage.setItem('nickname', nicknameInputEl.value);
        nicknameInputEl.value = '';
        const nicknameElement = document.getElementById('online-user');
        nicknameElement.innerText = sessionStorage.getItem('nickname');
    })

    socket.on('updateIdNicknameArray', (onlineUsers) => {
      const clientLi = document.getElementById('online-user');
      const nickname = sessionStorage.getItem('nickname');
      clientLi.innerText = nickname;
      const usersUl = document.getElementById("online-users")
      console.log(onlineUsers);
      onlineUsers.forEach((user) => {
        if(user !== nickname){
          const userLi = document.createElement('li');
          userLi.innerText = user;
          usersUl.appendChild(userLi);
        }
      })
    });

    window.onbeforeunload = function(event) {
      socket.disconnect();
    };

  </script>
</body>
</html>