<!DOCTYPE html>
<html>

<head>
    <title>TRYBE - WebChat</title>
    <style>
    </style>
</head>

<body>
    <h1> WebChat</h1>
    <div id="div-nickname">
        <input id="input-nickname" data-testid="nickname-box" />
        <button id="nickname-button" data-testid="nickname-button" type="button">Ok</button>
    </div>
    <div id="others"></div>
    <ul id="messages"></ul>
    <form id="form" action="">
        <input id="input" data-testid="message-box" />
        <button data-testid="send-button">Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const nicknameBtn = document.getElementById('nickname-button');
        nicknameBtn.addEventListener('click', (e) => {
            const inputNickname = document.getElementById('input-nickname');
            const div = document.getElementById('div-nickname');
            const dSpan = document.getElementById('online-user')
            div.removeChild(dSpan);
            const span = document.createElement('span');
            span.setAttribute("data-testid", "online-user");
            span.setAttribute("id", "online-user");
            span.textContent = inputNickname.value;
            div.appendChild(span);
            socket.emit('nickname', inputNickname.value);
        });
        window.onload = () => {
            let nickname = document.getElementById('nickname');
            let random = Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10);
            const div = document.getElementById('div-nickname');
            const span = document.createElement('span');
            span.setAttribute("data-testid", "online-user");
            span.setAttribute("id", "online-user");
            span.textContent = random;
            div.appendChild(span);
            socket.emit('adduser', random);
        };
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const span = document.querySelector('span');
            if (input.value) {
                const data = { nickname: span.innerText, chatMessage: input.value };
                socket.emit('message', data);
                input.value = '';
            }
        });
        socket.on('message', (message) => {
            const ul = document.getElementById('messages');
            const { dataAtual, horaAtual, data, nickname } = message;
            const li = document.createElement('li');
            li.setAttribute("data-testid", "message");
            li.textContent = message;
            ul.appendChild(li);
        })
        socket.on('guests', (guests) => {
            const indexAchado = guests.findIndex((item) => item.id === socket.id)
            guests.splice(indexAchado, 1);
            const div = document.getElementById('others');
            div.innerText = ""
            for (let i = 0; i < guests.length; i++) {
                const span = document.createElement('span');
                span.setAttribute("data-testid", "online-user");
                span.setAttribute("id", `online-user-${guests[i].id}`);
                span.textContent = guests[i].nome;
                div.appendChild(span);
            }
        })
        socket.on('history', (history) => {
            console.log(history);
            const ul = document.getElementById('messages');
            if (history.length === 0) {
                console.log('vazio');
            } else {
                for (let i = 0; i < history.length; i++) {
                    const { message, nickname } = history[i];
                    const date = new Date();
                    const dataAtual = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                    const horaAtual = `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
                    const dados = `${dataAtual} ${horaAtual} - ${nickname}: ${message}`;
                    const li = document.createElement('li');
                    li.setAttribute("data-testid", "message");
                    li.textContent = dados;
                    ul.appendChild(li);
                }
            }
        })
    </script>
</body>

</html>