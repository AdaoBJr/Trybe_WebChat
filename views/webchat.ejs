<html>
  <head>
    <title>Webchat</title>
    <link rel="stylesheet" href="/styles/main.css" />
  </head>
  <body>
    <header class="header__container">
      <img src="https://conteudo.imguol.com.br/78/2016/06/30/logo-bate-papo-uol-1467296899426_615x300.jpg" alt="logo">
    </header>
    <aside id="users__container" class="users__container"></aside>
    <main id="messages__container" class="messages__container">
      <% messages.forEach(({ timestamp, nickname, message }) => { %>
        <div data-testid="message">
          <%- `${timestamp} - <strong>${nickname}:</strong> ${message}`
          %>
        </div>
      <%})%>
    </main>
    <footer id="actions__container" class="actions__container">
      <h3 id="nickname__info">⭐</h3>
      <form class="actions__container__form">
        <input id="nickname-box" data-testid="nickname-box" type="text" placeholder="Apelido" />
        <button id="nickname-button" data-testid="nickname-button" type="button">Salvar</button>
        <input id="message-box" data-testid="message-box" type="text" placeholder="Digite sua menssagem..." />
        <button id="send-button" data-testid="send-button" type="button">Enviar</button>
      </form>
      <img src="https://www.clickssl.net/wp-content/uploads/2014/03/email-spamming-banner.jpg" alt="logo">
    </footer>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/scripts/main.js"></script>
    <script>
      const socket = io();
      let nickname = '';

      const nicknameBox = document.getElementById('nickname-box');
      const nicknameButton = document.getElementById('nickname-button');
      const messageBox = document.getElementById('message-box');
      const sendButton = document.getElementById('send-button');
      const messagesContainer = document.getElementById('messages__container');
      const usersContainer = document.getElementById('users__container');

      socket.on('onlineUsers', (users) => {
        const usersCards = document.querySelectorAll('.user');

        for (let index = 0; index < usersCards.length; index += 1) {
          usersContainer.removeChild(usersCards[index]);
        }

        const userNow = users.filter((user) => user.username === nickname);
        const orderedUsers = users.filter((user) => user.username !== nickname);

        orderedUsers.unshift(userNow[0]);

        orderedUsers.forEach((user) => {
          const userCard = document.createElement('div');

          userCard.setAttribute('data-testid', 'online-user');
          userCard.classList.add('user');
          userCard.textContent = `${user.username}`;
          usersContainer.appendChild(userCard);
        });
      });

      const renderMessage = (text) => {
        const message = document.createElement('div');

        message.setAttribute('data-testid', 'message');
        message.innerHTML = text;
        messagesContainer.appendChild(message);
      };

      sendButton.addEventListener('click', () => {
        if (messageBox.value) {
          const message = {
            chatMessage: messageBox.value,
            nickname,
          };

          socket.emit('message', message);
          messageBox.value = '';
          messageBox.focus();
        }
      });

      messageBox.addEventListener('keypress', ({ keyCode }) => {
        if (keyCode === 13) {
          sendButton.click();
        }
      });

      socket.on('message', (message) => {
        renderMessage(message);
      });

      nicknameButton.addEventListener('click', () => {
        nickname = nicknameBox.value;
        socket.emit('setNickname', nickname);
        document.getElementById('nickname__info').innerText = `⭐ ${nickname}`;
      });

      const generateRandomNickname = () => (
        Math.random().toString(36).substring(2, 15)
        + Math.random().toString(36).substring(2, 15)
      ).substring(0, 16);

      window.onload = () => {
        nickname = generateRandomNickname();

        socket.emit('connectUser', nickname);

        document.getElementById('nickname__info').innerText = `⭐ ${nickname}`;
      };
    </script>
  </body>
</html>