<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  </head>
  <body>
    <h1>Chat</h1>

    <ul id="onlineUsers">
     
    </ul>
    
    <div>
      Seu nick:<p id="nickUser"></p>
    </div>

    <div>
      Escolha seu novo nick:
      <input id="nickText" type="text" data-testid="nickname-box"/>
      <button id="submitNick" data-testid="nickname-button">Add</button>
    </div>

    <ul id="news">
      <%arrayMessages.forEach(({ message, nickname, timestamp }) => {%>
        <li data-testid="message"><%=`${timestamp} - ${nickname}: ${message}`%></li>
      <%})%>
    </ul>

    <div>
      Envie uma mensagem:
      <input id="text" type="text" data-testid="message-box"/>
      <button id="submit" data-testid="send-button">Add</button>
    </div>

    <script>
      const socket = io('http://localhost:3000');

      function setNick(param) {
        sessionStorage.setItem('nickname', JSON.stringify(param));
        const nickname = JSON.parse(sessionStorage.getItem('nickname'));
        const nick = document.getElementById('nickUser')
        nick.innerText = nickname;
      }

      function getNick() {
        const result = JSON.parse(sessionStorage.getItem('nickname'));

        return result;
      }

      socket.on('nickId', (cryptoNick) => {
        setNick(cryptoNick);
      });

      socket.on('onlineNicks', (nick) => {
        console.log('Entrei onlinenicks');

        nick.splice(nick.indexOf(getNick()), 1);

        nick.unshift(getNick());

        const messagesUl = document.querySelector('#onlineUsers');

        messagesUl.innerText = '';
      
        nick.forEach((nick) => {
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'online-user');
        li.innerText = nick;
        messagesUl.appendChild(li);
        })
      });

      const btn = document.getElementById('submit');
      btn.addEventListener('click', () => {
        const nickname = getNick();
        const chatMessage = document.getElementById('text');
        socket.emit('message', { nickname, chatMessage: chatMessage.value });
        chatMessage.value = '';
      });

      socket.on('message', (resp) => {
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'message');
        li.innerText = resp;
        li.class = "mensagens";
        const messagesUl = document.querySelector('#news');
        messagesUl.appendChild(li);
      });

      const btnNick = document.getElementById('submitNick');
      btnNick.addEventListener('click', () => {
        const newNick = document.getElementById('nickText');
        const nickname = getNick();
        setNick(newNick.value);
        socket.emit('changeNick', { oldNick: nickname, newNick: newNick.value });
        newNick.value = '';
      });

      window.onbeforeunload = function(event) {
        socket.disconnect();
      };

    </script>
  </body>
</html>
