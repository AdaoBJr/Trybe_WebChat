<!DOCTYPE html>
<html>
  <head>
    <title>ChatWeb</title>
    <!-- <link rel="stylesheet" type="text/css" href="public/style.css"> -->
    <style>
      #chat {
        align-items: stretch;
        display: flex;
        flex-direction: column-reverse;
        flex-grow: 1;
        height: 100vh;
        width: 70%; 
      }

      body {
        background-color: bisque;
      }

      #users {
        border: 1px;
        display: flex;
        width: 30%;
      }

      #users {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 30%;
      }

      #div-principal {
        display: flex;
        flex-direction: row-reverse;
        flex-grow: 1;
        width: 100%; 
      }

      input {
        border-radius: 2rem;
        flex-grow: 1;
        margin: 0.25rem;
        padding: 0 1rem;
        width: 80%;
      }
    </style>
  </head>
  <body>
    <div id="div-principal">
      <div id="chat">
        <ul></ul>
        <form action="">
          <input id="elementImput" data-testid="message-box" autocomplete="off"><button id="button-send-message" data-testid="send-button">Send</button>
        </form>
      </div>

      <div id="users">
        <form action="">
          <!-- <p id="user-nick" ></p> -->
          <input id="inputEditNick" data-testid="nickname-box" autocomplete="off"><button id="editar-nome" data-testid="nickname-button">Editar Nome</button>
          <ul id="ulUsers"></ul>
      </form>
    </div>
  </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      let nickname = Math.random()
        .toString(16).substr(2, 8) + Math.random().toString(16).substr(2, 8);
      
      const buttonChat = document.getElementById('button-send-message');
      const elementImput = document.querySelector('#elementImput')
      // const nick = document.getElementById("user-nick")
      const editarNome = document.getElementById("editar-nome");
      // const divUsers = document.getElementById("users");

      // nick.innerText = nickname;

      buttonChat.addEventListener('click', (e) => {
        e.preventDefault();
        const chatMessage = elementImput.value;
        socket.emit('message', { chatMessage, nickname })
        elementImput.value = ''
      })

      editarNome.addEventListener('click', (e) => {
        e.preventDefault();
        nickname = inputEditNick.value;
        // nick.innerText = nickname;
        console.log(nickname);
        socket.emit('usersConnected', { nickname });
        inputEditNick.value = ''
      })

      const createMessage = (message) => {
        const ul = document.querySelector('#chat');
        const li = document.createElement('li');
        li.setAttribute("data-testid", "message")
        li.innerText = message;
        ul.appendChild(li);
      }

      const createUsersOnline = (liUser) => {
        const ulUsers = document.getElementById("ulUsers");
        ulUsers.innerHTML = "";
        liUser.forEach(user => {
          const li = document.createElement('li');
          li.setAttribute("data-testid", "online-user")
          li.innerText = user.nickname;
          if (socket.id === user.id) {
            ulUsers.prepend(li);
          } else {
            ulUsers.appendChild(li);
          }
        });
      }

      socket.on('message', (message) => {
        createMessage(message);
      })

      socket.on('usersConnected', (usersConnected) => {
        createUsersOnline(usersConnected)
      })

      socket.emit('usersConnected', { nickname })

      window.onload = () => {
        fetch('http://localhost:3000/messages')
        .then((res) => res.json())
        .then((result) => {
          result.forEach((msg) => {
          createMessage(msg);
        })
      })}

    </script>
  </body>
</html>